blueprint:
  name: "Moto GeoRide - Suivi complet (v28.1)"
  description: |
    # ğŸï¸ Moto GeoRide - Suivi complet

    Blueprint de gestion complÃ¨te d'une moto Ã©quipÃ©e d'un tracker GeoRide.
    CrÃ©er **une instance par moto**. Utilise exclusivement les entitÃ©s de l'intÃ©gration **georide_trips** â€” aucun helper externe nÃ©cessaire.

    *Version : 2026.02.27*

    ---

    ### â›½ Autonomie carburant

    L'autonomie restante est calculÃ©e en temps rÃ©el par le sensor Python `sensor.<moto>_autonomie_restante`. Ce sensor utilise exclusivement `number.<moto>_autonomie_totale` comme rÃ©fÃ©rence â€” la moyenne calculÃ©e ne s'applique **jamais automatiquement**.

    Ã€ chaque confirmation de plein (dÃ¨s le 2Ã¨me), le blueprint attend 6 min puis envoie une notification de proposition : **"ğŸ“Š Nouvelle autonomie calculÃ©e : X km"** avec deux boutons :
    - **âœ… Appliquer** â†’ met Ã  jour l'autonomie de rÃ©fÃ©rence via `button.<moto>_appliquer_autonomie_calculee`
    - **âŒ Garder** â†’ rien ne change, tu conserves ta valeur actuelle

    Le bouton `button.<moto>_appliquer_autonomie_calculee` est Ã©galement utilisable manuellement depuis l'UI HA Ã  tout moment.

    ### ğŸ—ºï¸ Notification nouveau trajet

    La fin de trajet est dÃ©tectÃ©e par le **verrouillage du tracker** (`binary_sensor.<moto>_verrouille` â†’ OFF = verrouillÃ©), signal fiable d'arrÃªt dÃ©finitif. Le blueprint appuie immÃ©diatement sur **Refresh Trips** puis attend jusqu'Ã  3 min que `last_trip_sensor` se mette Ã  jour. La notification part dÃ¨s que les donnÃ©es sont fraÃ®ches.

    Le fallback `nouveau_trajet` (changement de `last_trip_sensor`) couvre le cas oÃ¹ le verrouillage n'a pas encore dÃ©clenchÃ©. Anti-doublon simple : si `locked_sensor` est passÃ© Ã  `off` (verrouillÃ©) depuis moins de 3 min, le fallback est ignorÃ© (trajet dÃ©jÃ  traitÃ©).

    ### ğŸ”— Entretien chaÃ®ne

    Alerte basÃ©e sur les km parcourus depuis le dernier entretien. Bouton **âœ… ChaÃ®ne entretenue** pour enregistrer (odometer + date).

    ### ğŸ›¢ï¸ Vidange

    Alerte basÃ©e sur les km parcourus depuis la derniÃ¨re vidange. Bouton **âœ… Vidange effectuÃ©e** pour enregistrer (odometer + date).

    ### ğŸ”§ RÃ©vision gÃ©nÃ©rale

    Double critÃ¨re : km **ET** jours. L'alerte se dÃ©clenche dÃ¨s que l'un des deux seuils est atteint. Bouton **âœ… RÃ©vision effectuÃ©e** pour enregistrer.

    ### ğŸ“… KilomÃ©trage pÃ©riodique

    Snapshots automatiques Ã  minuit (jour), lundi minuit (semaine) et au jour du mois configurable (mois).
    Les compteurs `sensor.<moto>_km_journaliers/hebdomadaires/mensuels` sont dÃ©sormais calculÃ©s en Python â€” rÃ©actifs instantanÃ©ment sans dÃ©pendre du blueprint.

    ### ğŸ“Š Bilans hebdomadaire et mensuel

    EnvoyÃ©s Ã  l'heure de votre choix en notification mobile et/ou persistante dans HA.

    ---

    ### ğŸ“‹ PrÃ©requis

    - IntÃ©gration **georide_trips** installÃ©e et configurÃ©e
    - Application **Home Assistant Companion** installÃ©e pour les notifications

  domain: automation

  input:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 1 â€” IDENTITÃ‰
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_identite:
      name: "ğŸï¸ IdentitÃ© de la moto"
      collapsed: false
      input:
        moto_nom:
          name: "Nom de la moto"
          description: >
            UtilisÃ© dans toutes les notifications.
            **Exemples :** Africa Twin, R1200GS, S1000RR
          selector:
            text:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 2 â€” CAPTEURS PRINCIPAUX
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_capteurs:
      name: "ğŸ“¡ Capteurs principaux (georide_trips)"
      collapsed: false
      input:
        odometer_sensor:
          name: "Capteur kilomÃ©trage (Odometer)"
          description: >
            `sensor.<moto>_odometer` â€” kilomÃ©trage rÃ©el avec offset.
          selector:
            entity:
              integration: georide_trips
              domain: sensor

        locked_sensor:
          name: "Capteur VerrouillÃ© (Locked)"
          description: >
            `binary_sensor.<moto>_verrouille` â€” fourni nativement par georide_trips.
            Passe Ã  `off` (= verrouillÃ©) quand la moto est Ã  l'arrÃªt confirmÃ© (polling 5 min).
            Signal fiable de fin de trajet, insensible aux arrÃªts temporaires (feux rouges, etc.).
          selector:
            entity:
              integration: georide_trips
              domain: binary_sensor

        last_trip_sensor:
          name: "Capteur dernier trajet (Last Trip Details)"
          description: >
            âš ï¸ Utiliser **Last Trip Details** (et non *Last Trip*).
            Il contient l'attribut `distance_km` nÃ©cessaire aux notifications.
          selector:
            entity:
              integration: georide_trips
              domain: sensor

        btn_refresh_trips:
          name: "Bouton Refresh Trips"
          description: >
            `button.<moto>_refresh_trips` â€” DÃ©clenche un rafraÃ®chissement immÃ©diat des trajets rÃ©cents.
            AppuyÃ© automatiquement Ã  chaque arrÃªt de la moto pour obtenir le dernier trajet sans attendre le polling horaire.
          selector:
            entity:
              integration: georide_trips
              domain: button


    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 3 â€” CARBURANT
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_carburant:
      name: "â›½ Carburant"
      collapsed: true
      input:
        n_autonomie_totale:
          name: "Autonomie totale (km sur un plein)"
          description: "`number.<moto>_autonomie_totale`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        n_seuil_alerte:
          name: "Seuil d'alerte autonomie (km)"
          description: >
            `number.<moto>_seuil_alerte_autonomie`
            Notification dÃ©clenchÃ©e quand les km restants passent sous ce seuil.
          selector:
            entity:
              integration: georide_trips
              domain: number

        n_km_dernier_plein:
          name: "KM au dernier plein"
          description: "`number.<moto>_km_au_dernier_plein`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        sensor_autonomie_restante:
          name: "Sensor autonomie restante (km)"
          description: >
            `sensor.<moto>_autonomie_restante`
            CalculÃ© en temps rÃ©el par l'intÃ©gration (moyenne glissante sur 3 pleins).
            UtilisÃ© pour dÃ©clencher l'alerte et afficher l'autonomie dans les bilans.
          selector:
            entity:
              integration: georide_trips
              domain: sensor

        btn_confirmer_le_plein:
          name: "Bouton â€” Confirmer le plein"
          description: >
            `button.<moto>_confirmer_le_plein`
            Enregistre l'odometer prÃ©cis au moment du plein (via API aprÃ¨s 5 min d'arrÃªt)
            et met Ã  jour la moyenne glissante. DÃ©sactive aussi le switch Faire le plein.
          selector:
            entity:
              integration: georide_trips
              domain: button

        switch_faire_le_plein:
          name: "Binary Sensor â€” Plein requis"
          description: >
            `binary_sensor.<moto>_plein_requis`
            Passe `on` automatiquement quand l'autonomie passe sous le seuil.
            Read-only â€” calculÃ© en temps rÃ©el par l'intÃ©gration.
          selector:
            entity:
              integration: georide_trips
              domain: binary_sensor

        btn_appliquer_autonomie:
          name: "Bouton â€” Appliquer l'autonomie calculÃ©e"
          description: >
            `button.<moto>_appliquer_autonomie_calculee`
            Copie la moyenne glissante dans l'autonomie totale de rÃ©fÃ©rence.
            AppuyÃ© automatiquement si tu confirmes via la notification de proposition.
          selector:
            entity:
              integration: georide_trips
              domain: button

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 5 â€” ENTRETIEN : CHAÃNE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_chaine:
      name: "ğŸ”— Entretien chaÃ®ne"
      collapsed: true
      input:
        n_intervalle_km_chaine:
          name: "Intervalle km entre entretiens"
          description: "`number.<moto>_entretien_chaine_intervalle_km`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        n_seuil_alerte_chaine:
          name: "Seuil d'alerte (km restants)"
          description: "`number.<moto>_entretien_chaine_seuil_alerte`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        n_km_dernier_entretien_chaine:
          name: "KM au dernier entretien"
          description: "`number.<moto>_entretien_chaine_km_au_dernier_entretien`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        dt_date_dernier_entretien_chaine:
          name: "Date du dernier entretien"
          description: "`datetime.<moto>_entretien_chaine_date_dernier_entretien`"
          selector:
            entity:
              integration: georide_trips
              domain: datetime

        switch_entretien_chaine:
          name: "Binary Sensor â€” Entretien chaÃ®ne requis"
          description: >
            `binary_sensor.<moto>_chaine_requise`
            Passe `on` automatiquement quand les km restants passent sous le seuil.
            Read-only â€” calculÃ© en temps rÃ©el par l'intÃ©gration.
          selector:
            entity:
              integration: georide_trips
              domain: binary_sensor

        btn_enregistrer_chaine:
          name: "Bouton enregistrer entretien chaÃ®ne"
          description: >
            Bouton natif georide_trips.
            DÃ©clenche la mÃªme sÃ©quence que la confirmation mobile.
          selector:
            entity:
              integration: georide_trips
              domain: button

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 6 â€” ENTRETIEN : VIDANGE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_vidange:
      name: "ğŸ›¢ï¸ Vidange"
      collapsed: true
      input:
        n_intervalle_km_vidange:
          name: "Intervalle km entre vidanges"
          description: "`number.<moto>_vidange_intervalle_km`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        n_seuil_alerte_vidange:
          name: "Seuil d'alerte (km restants)"
          description: "`number.<moto>_vidange_seuil_alerte`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        n_km_dernier_entretien_vidange:
          name: "KM Ã  la derniÃ¨re vidange"
          description: "`number.<moto>_vidange_km_a_la_derniere_vidange`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        dt_date_dernier_entretien_vidange:
          name: "Date de la derniÃ¨re vidange"
          description: "`datetime.<moto>_vidange_date_derniere_vidange`"
          selector:
            entity:
              integration: georide_trips
              domain: datetime

        switch_entretien_vidange:
          name: "Binary Sensor â€” Vidange requise"
          description: >
            `binary_sensor.<moto>_vidange_requise`
            Passe `on` automatiquement quand les km restants passent sous le seuil.
            Read-only â€” calculÃ© en temps rÃ©el par l'intÃ©gration.
          selector:
            entity:
              integration: georide_trips
              domain: binary_sensor

        btn_enregistrer_vidange:
          name: "Bouton enregistrer vidange"
          description: >
            Bouton natif georide_trips.
            DÃ©clenche la mÃªme sÃ©quence que la confirmation mobile.
          selector:
            entity:
              integration: georide_trips
              domain: button

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 7 â€” ENTRETIEN : RÃ‰VISION GÃ‰NÃ‰RALE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_revision:
      name: "ğŸ”§ RÃ©vision gÃ©nÃ©rale"
      collapsed: true
      input:
        n_intervalle_km_revision:
          name: "Intervalle km entre rÃ©visions"
          description: "`number.<moto>_revision_intervalle_km`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        n_intervalle_jours_revision:
          name: "Intervalle maximum en jours"
          description: >
            `number.<moto>_revision_intervalle_jours`
            L'alerte se dÃ©clenche si l'un des deux critÃ¨res (km **ou** jours) est atteint.
          selector:
            entity:
              integration: georide_trips
              domain: number

        n_seuil_alerte_revision:
          name: "Seuil d'alerte (km restants)"
          description: "`number.<moto>_revision_seuil_alerte`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        n_km_dernier_entretien_revision:
          name: "KM Ã  la derniÃ¨re rÃ©vision"
          description: "`number.<moto>_revision_km_a_la_derniere_revision`"
          selector:
            entity:
              integration: georide_trips
              domain: number

        dt_date_dernier_entretien_revision:
          name: "Date de la derniÃ¨re rÃ©vision"
          description: "`datetime.<moto>_revision_date_derniere_revision`"
          selector:
            entity:
              integration: georide_trips
              domain: datetime

        switch_entretien_revision:
          name: "Binary Sensor â€” RÃ©vision requise"
          description: >
            `binary_sensor.<moto>_revision_requise`
            Passe `on` automatiquement quand km OU dÃ©lai passent sous le seuil.
            Read-only â€” calculÃ© en temps rÃ©el par l'intÃ©gration.
          selector:
            entity:
              integration: georide_trips
              domain: binary_sensor

        btn_enregistrer_revision:
          name: "Bouton enregistrer rÃ©vision"
          description: >
            Bouton natif georide_trips.
            DÃ©clenche la mÃªme sÃ©quence que la confirmation mobile.
          selector:
            entity:
              integration: georide_trips
              domain: button

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 8 â€” NOTIFICATIONS & TRAJETS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_notifications:
      name: "ğŸ”” Notifications & Trajets"
      collapsed: false
      input:
        notify_service:
          name: "Service de notification mobile"
          description: >
            Format : `notify.nom_du_service`
            Retrouvez vos services dans **Outils de dÃ©veloppement â†’ Services** (domaine `notify`).
          default: "notify."
          selector:
            text:

        notif_autonomie_active:
          name: "Activer â€” Alerte autonomie carburant"
          default: true
          selector:
            boolean:

        notif_trajet_active:
          name: "Activer â€” Notification nouveau trajet"
          default: true
          selector:
            boolean:

        notif_chaine_active:
          name: "Activer â€” Alerte entretien chaÃ®ne"
          default: true
          selector:
            boolean:

        notif_vidange_active:
          name: "Activer â€” Alerte vidange"
          default: true
          selector:
            boolean:

        notif_revision_active:
          name: "Activer â€” Alerte rÃ©vision gÃ©nÃ©rale"
          default: true
          selector:
            boolean:

        n_seuil_distance_trajet:
          name: "Seuil minimum pour notifier un trajet (km)"
          description: >
            `number.<moto>_seuil_notification_trajet`
            Les trajets infÃ©rieurs Ã  cette distance ne gÃ©nÃ¨rent pas de notification.
          selector:
            entity:
              integration: georide_trips
              domain: number

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 9 â€” ACTIONS MOBILES
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_actions:
      name: "ğŸ“² Actions mobiles (identifiants uniques)"
      collapsed: true
      input:
        action_plein:
          name: "Action mobile â€” Confirmer le plein"
          description: >
            Identifiant unique, **diffÃ©rent pour chaque moto**.
            **Exemple :** `PLEIN_AFRICA_TWIN`
          selector:
            text:

        action_appliquer_autonomie:
          name: "Action mobile â€” Appliquer l'autonomie calculÃ©e"
          description: >
            Identifiant unique, **diffÃ©rent pour chaque moto**.
            UtilisÃ© par la notification de proposition aprÃ¨s chaque plein (dÃ¨s le 2Ã¨me).
            **Exemple :** `APPLIQUER_AUTO_AFRICA_TWIN`
          selector:
            text:

        action_chaine:
          name: "Action mobile â€” Confirmer entretien chaÃ®ne"
          description: >
            Identifiant unique par moto.
            **Exemple :** `CHAINE_AFRICA_TWIN`
          selector:
            text:

        action_vidange:
          name: "Action mobile â€” Confirmer vidange"
          description: >
            Identifiant unique par moto.
            **Exemple :** `VIDANGE_AFRICA_TWIN`
          selector:
            text:

        action_revision:
          name: "Action mobile â€” Confirmer rÃ©vision"
          description: >
            Identifiant unique par moto.
            **Exemple :** `REVISION_AFRICA_TWIN`
          selector:
            text:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 9b â€” PERSONNALISATION DES NOTIFICATIONS
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_notif_custom:
      name: "âœï¸ Personnalisation des notifications"
      collapsed: true
      input:

        # â”€â”€ TRAJET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        notif_trajet_titre:
          name: "Trajet â€” Titre"
          description: >
            Variables disponibles : `{{ moto_nom }}`, `{{ distance_trajet | round(1) }}`,
            `{{ odometer_km_frais | round(0) }}`, `{{ km_restants_trajet }}`
          default: "ğŸï¸ Trajet â€” {{ moto_nom }}"
          selector:
            text:

        notif_trajet_message:
          name: "Trajet â€” Message"
          description: >
            Variables : `{{ distance_trajet | round(1) }}` (km du trajet),
            `{{ odometer_km_frais | round(0) }}` (km total),
            `{{ km_restants_trajet }}` (autonomie restante km).
          default: "{{ distance_trajet | round(1) }} km parcourus.\nAutonomie restante : {{ km_restants_trajet }} km."
          selector:
            text:
              multiline: true

        notif_trajet_persistante:
          name: "Trajet â€” Notification persistante dans HA"
          default: false
          selector:
            boolean:

        # â”€â”€ AUTONOMIE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        notif_autonomie_titre:
          name: "Autonomie â€” Titre"
          description: >
            Variables : `{{ moto_nom }}`, `{{ km_restants }}` (autonomie restante), `{{ odometer_km | round(0) }}`
          default: "â›½ Plein Ã  faire â€” {{ moto_nom }}"
          selector:
            text:

        notif_autonomie_message:
          name: "Autonomie â€” Message"
          description: >
            Variables : `{{ km_restants }}` (km autonomie restante), `{{ odometer_km | round(0) }}` (km total).
          default: "Il reste {{ km_restants }} km d'autonomie.\nKilomÃ©trage actuel : {{ odometer_km | round(0) }} km."
          selector:
            text:
              multiline: true

        notif_autonomie_persistante:
          name: "Autonomie â€” Notification persistante dans HA"
          default: false
          selector:
            boolean:

        # â”€â”€ CHAÃNE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        notif_chaine_titre:
          name: "ChaÃ®ne â€” Titre"
          description: >
            Variables : `{{ moto_nom }}`, `{{ km_depuis_chaine }}`, `{{ km_restants_chaine }}`
          default: "ğŸ”— Entretien chaÃ®ne â€” {{ moto_nom }}"
          selector:
            text:

        notif_chaine_message:
          name: "ChaÃ®ne â€” Message"
          description: >
            Variables : `{{ km_depuis_chaine }}` (km depuis dernier entretien),
            `{{ km_restants_chaine }}` (km restants avant Ã©chÃ©ance).
          default: "{{ km_depuis_chaine }} km depuis le dernier entretien.\nIl reste {{ km_restants_chaine }} km avant l'Ã©chÃ©ance.\nDernier entretien : {{ (states(dt_date_dernier_entretien_chaine) | as_datetime | as_local).strftime('%d/%m/%Y') }}."
          selector:
            text:
              multiline: true

        notif_chaine_persistante:
          name: "ChaÃ®ne â€” Notification persistante dans HA"
          default: false
          selector:
            boolean:

        # â”€â”€ VIDANGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        notif_vidange_titre:
          name: "Vidange â€” Titre"
          description: >
            Variables : `{{ moto_nom }}`, `{{ km_depuis_vidange }}`, `{{ km_restants_vidange }}`
          default: "ğŸ›¢ï¸ Vidange Ã  faire â€” {{ moto_nom }}"
          selector:
            text:

        notif_vidange_message:
          name: "Vidange â€” Message"
          description: >
            Variables : `{{ km_depuis_vidange }}`, `{{ km_restants_vidange }}`.
          default: "{{ km_depuis_vidange }} km depuis la derniÃ¨re vidange.\nIl reste {{ km_restants_vidange }} km avant l'Ã©chÃ©ance.\nDerniÃ¨re vidange : {{ (states(dt_date_dernier_entretien_vidange) | as_datetime | as_local).strftime('%d/%m/%Y') }}."
          selector:
            text:
              multiline: true

        notif_vidange_persistante:
          name: "Vidange â€” Notification persistante dans HA"
          default: false
          selector:
            boolean:

        # â”€â”€ RÃ‰VISION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        notif_revision_titre:
          name: "RÃ©vision â€” Titre"
          description: >
            Variables : `{{ moto_nom }}`, `{{ km_depuis_revision }}`, `{{ km_restants_revision }}`,
            `{{ jours_depuis_revision }}`, `{{ jours_restants_revision }}`
          default: "ğŸ”§ RÃ©vision Ã  prÃ©voir â€” {{ moto_nom }}"
          selector:
            text:

        notif_revision_message:
          name: "RÃ©vision â€” Message"
          description: >
            Variables : `{{ km_depuis_revision }}`, `{{ km_restants_revision }}`,
            `{{ jours_depuis_revision }}`, `{{ jours_restants_revision }}`,
            `{{ alerte_revision_km }}` (boolÃ©en), `{{ alerte_revision_jours }}` (boolÃ©en).
          default: >
            {% if alerte_revision_km and alerte_revision_jours %}RÃ©vision urgente : km ET dÃ©lai atteints.
            {% elif alerte_revision_km %}RÃ©vision proche par kilomÃ©trage.
            {% else %}RÃ©vision proche par dÃ©lai.{% endif %}
            {{ km_depuis_revision }} km parcourus ({{ km_restants_revision }} km restants).
            {{ jours_depuis_revision }} jours Ã©coulÃ©s ({{ jours_restants_revision }} jours restants).
            DerniÃ¨re rÃ©vision : {{ (states(dt_date_dernier_entretien_revision) | as_datetime | as_local).strftime('%d/%m/%Y') }}.
          selector:
            text:
              multiline: true

        notif_revision_persistante:
          name: "RÃ©vision â€” Notification persistante dans HA"
          default: false
          selector:
            boolean:


    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 9b â€” ALARMES
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_alarmes:
      name: "ğŸš¨ Alarmes"
      collapsed: true
      input:
        last_alarm_sensor:
          name: "Capteur derniÃ¨re alarme (Last Alarm)"
          description: >
            `sensor.<moto>_last_alarm` â€” fourni par georide_trips.
            Change d'Ã©tat Ã  chaque nouvelle alarme reÃ§ue via Socket.IO.
            Expose aussi `timestamp` et `device_name` en attributs.
          selector:
            entity:
              integration: georide_trips
              domain: sensor

        notif_alarme_crash:
          name: "Activer â€” Alerte chute/crash"
          description: "Notifie pour les alarmes `alarm_crash` et `alarm_crashParking`."
          default: true
          selector:
            boolean:

        notif_alarme_vol:
          name: "Activer â€” Alerte vibration / mouvement suspect"
          description: "Notifie pour l'alarme `alarm_vibration` (dÃ©tection de mouvement suspect)."
          default: true
          selector:
            boolean:

        notif_alarme_alimentation:
          name: "Activer â€” Alerte coupure alimentation"
          description: "Notifie pour les alarmes `alarm_powerCut` et `alarm_powerUncut`."
          default: false
          selector:
            boolean:

        notif_alarme_autres:
          name: "Activer â€” Autres alarmes (zone, batterie, tempÃ©ratureâ€¦)"
          description: >
            Notifie pour les alarmes non couvertes ci-dessus :
            `alarm_exitZone`, `alarm_batteryWarning`, `alarm_temperatureWarning`,
            `alarm_deviceOffline`, `alarm_deviceOnline`, `alarm_magnetOn/Off`, `alarm_sonorAlarmOn`.
          default: false
          selector:
            boolean:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 10 â€” BILAN HEBDOMADAIRE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_hebdo:
      name: "ğŸ“Š Bilan hebdomadaire"
      collapsed: true
      input:
        activer_stats_hebdo:
          name: "Activer le bilan hebdomadaire"
          default: true
          selector:
            boolean:

        heure_stats_hebdo:
          name: "Heure d'envoi du bilan hebdomadaire"
          default: "09:00:00"
          selector:
            time:

        stats_hebdo_mobile:
          name: "Bilan hebdo â€” Notification mobile"
          default: true
          selector:
            boolean:

        stats_hebdo_persistante:
          name: "Bilan hebdo â€” Notification persistante dans HA"
          default: true
          selector:
            boolean:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # SECTION 11 â€” BILAN MENSUEL
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    section_mensuel:
      name: "ğŸ“Š Bilan mensuel"
      collapsed: true
      input:
        activer_stats_mensuelles:
          name: "Activer le bilan mensuel"
          default: true
          selector:
            boolean:

        heure_stats_mensuelles:
          name: "Heure d'envoi du bilan mensuel"
          default: "09:00:00"
          selector:
            time:

        stats_mensuelles_mobile:
          name: "Bilan mensuel â€” Notification mobile"
          default: true
          selector:
            boolean:

        stats_mensuelles_persistante:
          name: "Bilan mensuel â€” Notification persistante dans HA"
          default: true
          selector:
            boolean:

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VARIABLES GLOBALES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
variables:
  moto_nom: !input moto_nom
  odometer_sensor: !input odometer_sensor
  n_autonomie_totale: !input n_autonomie_totale
  n_seuil_alerte: !input n_seuil_alerte
  n_km_dernier_plein: !input n_km_dernier_plein
  sensor_autonomie_restante: !input sensor_autonomie_restante
  btn_confirmer_le_plein: !input btn_confirmer_le_plein
  switch_faire_le_plein: !input switch_faire_le_plein
  btn_appliquer_autonomie: !input btn_appliquer_autonomie
  switch_entretien_chaine: !input switch_entretien_chaine
  switch_entretien_vidange: !input switch_entretien_vidange
  switch_entretien_revision: !input switch_entretien_revision
  n_intervalle_km_chaine: !input n_intervalle_km_chaine
  n_seuil_alerte_chaine: !input n_seuil_alerte_chaine
  n_km_dernier_entretien_chaine: !input n_km_dernier_entretien_chaine
  dt_date_dernier_entretien_chaine: !input dt_date_dernier_entretien_chaine
  n_intervalle_km_vidange: !input n_intervalle_km_vidange
  n_seuil_alerte_vidange: !input n_seuil_alerte_vidange
  n_km_dernier_entretien_vidange: !input n_km_dernier_entretien_vidange
  dt_date_dernier_entretien_vidange: !input dt_date_dernier_entretien_vidange
  n_intervalle_km_revision: !input n_intervalle_km_revision
  n_intervalle_jours_revision: !input n_intervalle_jours_revision
  n_seuil_alerte_revision: !input n_seuil_alerte_revision
  n_km_dernier_entretien_revision: !input n_km_dernier_entretien_revision
  dt_date_dernier_entretien_revision: !input dt_date_dernier_entretien_revision
  n_seuil_distance_trajet: !input n_seuil_distance_trajet
  notify_service: !input notify_service
  notif_autonomie_active: !input notif_autonomie_active
  notif_trajet_active: !input notif_trajet_active
  notif_chaine_active: !input notif_chaine_active
  notif_vidange_active: !input notif_vidange_active
  notif_revision_active: !input notif_revision_active
  action_plein: !input action_plein
  action_appliquer_autonomie: !input action_appliquer_autonomie
  action_chaine: !input action_chaine
  action_vidange: !input action_vidange
  action_revision: !input action_revision
  # Note : les inputs de personnalisation des notifications (notif_*_titre, notif_*_message,
  # notif_*_persistante) ne sont PAS stockÃ©s en variables globales car leurs valeurs par dÃ©faut
  # contiennent des templates Jinja2 dynamiques (ex: {{ distance_trajet }}) qui ne sont pas
  # encore dÃ©finies Ã  ce stade. Ils sont utilisÃ©s directement via !input dans les actions.
  btn_enregistrer_chaine: !input btn_enregistrer_chaine
  btn_enregistrer_vidange: !input btn_enregistrer_vidange
  btn_enregistrer_revision: !input btn_enregistrer_revision
  btn_refresh_trips: !input btn_refresh_trips
  activer_stats_hebdo: !input activer_stats_hebdo
  activer_stats_mensuelles: !input activer_stats_mensuelles
  stats_hebdo_mobile: !input stats_hebdo_mobile
  stats_hebdo_persistante: !input stats_hebdo_persistante
  stats_mensuelles_mobile: !input stats_mensuelles_mobile
  stats_mensuelles_persistante: !input stats_mensuelles_persistante
  last_alarm_sensor: !input last_alarm_sensor
  notif_alarme_crash: !input notif_alarme_crash
  notif_alarme_vol: !input notif_alarme_vol
  notif_alarme_alimentation: !input notif_alarme_alimentation
  notif_alarme_autres: !input notif_alarme_autres
  locked_sensor: !input locked_sensor

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# TRIGGERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
triggers:

  - trigger: state
    entity_id: !input locked_sensor
    to: "off"
    id: moto_verrouillee
    not_from:
      - "unavailable"
      - "unknown"

  - trigger: state
    entity_id: !input last_trip_sensor
    id: nouveau_trajet
    not_from:
      - "unavailable"
      - "unknown"
    not_to:
      - "unavailable"
      - "unknown"

  - trigger: time
    at: !input heure_stats_hebdo
    id: stats_hebdo

  - trigger: time
    at: !input heure_stats_mensuelles
    id: stats_mensuelles

  - trigger: event
    event_type: mobile_app_notification_action
    event_data:
      action: !input action_plein
    id: confirm_plein

  - trigger: event
    event_type: mobile_app_notification_action
    event_data:
      action: !input action_appliquer_autonomie
    id: confirm_appliquer_autonomie

  - trigger: event
    event_type: mobile_app_notification_action
    event_data:
      action: !input action_chaine
    id: confirm_chaine

  - trigger: event
    event_type: mobile_app_notification_action
    event_data:
      action: !input action_vidange
    id: confirm_vidange

  - trigger: event
    event_type: mobile_app_notification_action
    event_data:
      action: !input action_revision
    id: confirm_revision

  - trigger: state
    entity_id: !input btn_enregistrer_chaine
    id: confirm_chaine
    not_from:
      - "unavailable"
      - "unknown"
    not_to:
      - "unavailable"
      - "unknown"

  - trigger: state
    entity_id: !input btn_enregistrer_vidange
    id: confirm_vidange
    not_from:
      - "unavailable"
      - "unknown"
    not_to:
      - "unavailable"
      - "unknown"

  - trigger: state
    entity_id: !input btn_enregistrer_revision
    id: confirm_revision
    not_from:
      - "unavailable"
      - "unknown"
    not_to:
      - "unavailable"
      - "unknown"

  - trigger: state
    entity_id: !input last_alarm_sensor
    id: nouvelle_alarme
    not_from:
      - "unavailable"
      - "unknown"
    not_to:
      - "unavailable"
      - "unknown"

  # Triggers binary sensors calculÃ©s â€” notification envoyÃ©e exactement une fois
  # lors du passage offâ†’on (seuil franchi). Pas d'anti-doublon manuel nÃ©cessaire.

  - trigger: state
    entity_id: !input switch_faire_le_plein
    from: "off"
    to: "on"
    id: alerte_plein

  - trigger: state
    entity_id: !input switch_entretien_chaine
    from: "off"
    to: "on"
    id: alerte_chaine

  - trigger: state
    entity_id: !input switch_entretien_vidange
    from: "off"
    to: "on"
    id: alerte_vidange

  - trigger: state
    entity_id: !input switch_entretien_revision
    from: "off"
    to: "on"
    id: alerte_revision

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ACTIONS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
actions:
  - choose:

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â›½ ALERTE PLEIN â€” binary_sensor offâ†’on
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: alerte_plein
        - condition: template
          value_template: "{{ notif_autonomie_active }}"
      sequence:
        - variables:
            odometer_km: "{{ states(odometer_sensor) | float(0) }}"
            km_restants: "{{ states(sensor_autonomie_restante) | float(0) | round(1) }}"
        - action: "{{ notify_service }}"
          data:
            title: !input notif_autonomie_titre
            message: !input notif_autonomie_message
            data:
              actions:
                - action: "{{ action_plein }}"
                  title: "âœ… Plein effectuÃ©"
        - if:
            - condition: template
              value_template: !input notif_autonomie_persistante
          then:
            - action: persistent_notification.create
              data:
                title: !input notif_autonomie_titre
                message: !input notif_autonomie_message
                notification_id: "autonomie_{{ moto_nom | slugify }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ”— ALERTE CHAÃNE â€” binary_sensor offâ†’on
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: alerte_chaine
        - condition: template
          value_template: "{{ notif_chaine_active }}"
      sequence:
        - variables:
            odometer_km: "{{ states(odometer_sensor) | float(0) }}"
            km_depuis_chaine: "{{ [odometer_km - states(n_km_dernier_entretien_chaine) | float(0), 0] | max | round(0) }}"
            km_restants_chaine: "{{ [states(n_intervalle_km_chaine) | float(500) - km_depuis_chaine, 0] | max | round(0) }}"
        - action: "{{ notify_service }}"
          data:
            title: !input notif_chaine_titre
            message: !input notif_chaine_message
            data:
              actions:
                - action: "{{ action_chaine }}"
                  title: "âœ… ChaÃ®ne entretenue"
        - if:
            - condition: template
              value_template: !input notif_chaine_persistante
          then:
            - action: persistent_notification.create
              data:
                title: !input notif_chaine_titre
                message: !input notif_chaine_message
                notification_id: "chaine_{{ moto_nom | slugify }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ›¢ï¸ ALERTE VIDANGE â€” binary_sensor offâ†’on
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: alerte_vidange
        - condition: template
          value_template: "{{ notif_vidange_active }}"
      sequence:
        - variables:
            odometer_km: "{{ states(odometer_sensor) | float(0) }}"
            km_depuis_vidange: "{{ [odometer_km - states(n_km_dernier_entretien_vidange) | float(0), 0] | max | round(0) }}"
            km_restants_vidange: "{{ [states(n_intervalle_km_vidange) | float(6000) - km_depuis_vidange, 0] | max | round(0) }}"
        - action: "{{ notify_service }}"
          data:
            title: !input notif_vidange_titre
            message: !input notif_vidange_message
            data:
              actions:
                - action: "{{ action_vidange }}"
                  title: "âœ… Vidange effectuÃ©e"
        - if:
            - condition: template
              value_template: !input notif_vidange_persistante
          then:
            - action: persistent_notification.create
              data:
                title: !input notif_vidange_titre
                message: !input notif_vidange_message
                notification_id: "vidange_{{ moto_nom | slugify }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ”§ ALERTE RÃ‰VISION â€” binary_sensor offâ†’on
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: alerte_revision
        - condition: template
          value_template: "{{ notif_revision_active }}"
      sequence:
        - variables:
            odometer_km: "{{ states(odometer_sensor) | float(0) }}"
            km_depuis_revision: "{{ [odometer_km - states(n_km_dernier_entretien_revision) | float(0), 0] | max | round(0) }}"
            km_restants_revision: "{{ [states(n_intervalle_km_revision) | float(6000) - km_depuis_revision, 0] | max | round(0) }}"
            jours_depuis_revision: "{{ ((now() - (states(dt_date_dernier_entretien_revision) | as_datetime | as_local)).days) | int(0) }}"
            jours_restants_revision: "{{ [states(n_intervalle_jours_revision) | int(365) - jours_depuis_revision, 0] | max }}"
            alerte_revision_km: "{{ km_restants_revision <= states(n_seuil_alerte_revision) | float(500) }}"
            alerte_revision_jours: "{{ jours_restants_revision <= 30 }}"
        - action: "{{ notify_service }}"
          data:
            title: !input notif_revision_titre
            message: !input notif_revision_message
            data:
              actions:
                - action: "{{ action_revision }}"
                  title: "âœ… RÃ©vision effectuÃ©e"
        - if:
            - condition: template
              value_template: !input notif_revision_persistante
          then:
            - action: persistent_notification.create
              data:
                title: !input notif_revision_titre
                message: !input notif_revision_message
                notification_id: "revision_{{ moto_nom | slugify }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ—ºï¸ NOUVEAU TRAJET (voie principale)
    # DÃ©clenchÃ©e par moto_verrouillee (locked_sensor â†’ OFF = verrouillÃ©).
    # Signal fiable d'arrÃªt dÃ©finitif, insensible aux feux rouges.
    #
    # StratÃ©gie :
    #   1. Appuyer sur btn_refresh_trips pour forcer un fetch immÃ©diat de l'API.
    #   2. Attendre (wait_for_trigger) que last_trip_sensor change, max 3 min.
    #   3. Lire distance_trajet depuis wait.trigger.to_state.attributes (donnÃ©es
    #      fraÃ®ches du trigger) ou fallback state_attr si timeout.
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: moto_verrouillee
        - condition: template
          value_template: "{{ notif_trajet_active }}"
      sequence:
        # Forcer un refresh immÃ©diat des trajets
        - action: button.press
          target:
            entity_id: !input btn_refresh_trips

        # Attendre que last_trip_sensor change (max 3 min)
        - wait_for_trigger:
            - trigger: state
              entity_id: !input last_trip_sensor
              not_to:
                - "unavailable"
                - "unknown"
          timeout:
            minutes: 3
          continue_on_timeout: true

        # Lire la distance depuis les attributs du trigger (donnÃ©es fraÃ®ches)
        # ou fallback sur state_attr si timeout (wait.trigger est None)
        - variables:
            distance_trajet: >
              {% if wait.trigger %}
                {{ wait.trigger.to_state.attributes.distance_km | float(0) }}
              {% else %}
                {{ state_attr(last_trip_sensor, 'distance_km') | float(0) }}
              {% endif %}

        # Sortie anticipÃ©e si trajet trop court
        - condition: template
          value_template: "{{ distance_trajet >= states(n_seuil_distance_trajet) | float(2) }}"

        # Lire l'odometer (Ã  jour via Socket.IO)
        - variables:
            odometer_km_frais: "{{ states(odometer_sensor) | float(0) }}"
            km_restants_trajet: "{{ states(sensor_autonomie_restante) | float(0) | round(1) }}"

        # Notification
        - action: "{{ notify_service }}"
          data:
            title: !input notif_trajet_titre
            message: !input notif_trajet_message
        - if:
            - condition: template
              value_template: !input notif_trajet_persistante
          then:
            - action: persistent_notification.create
              data:
                title: !input notif_trajet_titre
                message: !input notif_trajet_message
                notification_id: "trajet_{{ moto_nom | slugify }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ—ºï¸ NOUVEAU TRAJET (fallback)
    # DÃ©clenchÃ© par nouveau_trajet (changement de last_trip_sensor).
    # Couvre le cas oÃ¹ le verrouillage n'a pas encore dÃ©clenchÃ© moto_verrouillee.
    #
    # Anti-doublon simple : si locked_sensor est passÃ© Ã  "off" (verrouillÃ©)
    # depuis moins de 3 min, c'est que moto_verrouillee a dÃ©jÃ  traitÃ©
    # ce trajet â†’ on ignore.
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: nouveau_trajet
        - condition: template
          value_template: "{{ notif_trajet_active }}"
        # Anti-doublon : si locked_sensor vient de passer Ã  off (< 3 min),
        # moto_verrouillee a dÃ©jÃ  gÃ©rÃ© la notification â†’ on sort
        - condition: template
          value_template: >
            {% set last_changed = states[locked_sensor].last_changed %}
            {% if last_changed %}
              {{ (now() - last_changed).total_seconds() > 180 or not is_state(locked_sensor, 'off') }}
            {% else %}
              true
            {% endif %}
      sequence:
        # Lire la distance depuis les attributs du trigger (donnÃ©es fraÃ®ches du changement)
        - variables:
            distance_trajet: "{{ trigger.to_state.attributes.distance_km | float(0) }}"

        # Sortie anticipÃ©e si trajet trop court
        - condition: template
          value_template: "{{ distance_trajet >= states(n_seuil_distance_trajet) | float(2) }}"

        # Lire l'odometer frais
        - variables:
            odometer_km_frais: "{{ states(odometer_sensor) | float(0) }}"
            km_restants_trajet: "{{ states(sensor_autonomie_restante) | float(0) | round(1) }}"

        # Notification
        - action: "{{ notify_service }}"
          data:
            title: !input notif_trajet_titre
            message: !input notif_trajet_message
        - if:
            - condition: template
              value_template: !input notif_trajet_persistante
          then:
            - action: persistent_notification.create
              data:
                title: !input notif_trajet_titre
                message: !input notif_trajet_message
                notification_id: "trajet_{{ moto_nom | slugify }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“Š BILAN HEBDOMADAIRE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: stats_hebdo
        - condition: template
          value_template: "{{ activer_stats_hebdo and now().weekday() == 0 }}"
      sequence:
        - variables:
            n_km_debut_semaine: "{{ odometer_sensor | replace('sensor.', 'number.') | replace('_odometer', '_km_debut_semaine') }}"
            km_semaine: "{{ [states(odometer_sensor) | float(0) - states(n_km_debut_semaine) | float(0), 0] | max | round(1) }}"
            odometer_km: "{{ states(odometer_sensor) | float(0) | round(0) }}"
            km_restants_notif: "{{ states(sensor_autonomie_restante) | float(0) | round(1) }}"
            message_hebdo: >
              Bilan semaine â€” {{ moto_nom }} :
              {{ km_semaine }} km cette semaine.
              KilomÃ©trage total : {{ odometer_km }} km.
              Autonomie restante : {{ km_restants_notif }} km.
        - if:
            - condition: template
              value_template: "{{ stats_hebdo_mobile }}"
          then:
            - action: "{{ notify_service }}"
              data:
                title: "ğŸ“Š Bilan hebdo â€” {{ moto_nom }}"
                message: "{{ message_hebdo }}"
        - if:
            - condition: template
              value_template: "{{ stats_hebdo_persistante }}"
          then:
            - action: persistent_notification.create
              data:
                title: "ğŸ“Š Bilan hebdo â€” {{ moto_nom }}"
                message: "{{ message_hebdo }}"
                notification_id: "stats_hebdo_{{ moto_nom | slugify }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸ“Š BILAN MENSUEL
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: stats_mensuelles
        - condition: template
          value_template: >
            {% set n_jour = odometer_sensor | replace('sensor.', 'number.') | replace('_odometer', '_jour_stats_mensuelles') %}
            {{ activer_stats_mensuelles and now().day == states(n_jour) | int(1) }}
      sequence:
        - variables:
            n_km_debut_mois: "{{ odometer_sensor | replace('sensor.', 'number.') | replace('_odometer', '_km_debut_mois') }}"
            km_mois: "{{ [states(odometer_sensor) | float(0) - states(n_km_debut_mois) | float(0), 0] | max | round(1) }}"
            odometer_km: "{{ states(odometer_sensor) | float(0) | round(0) }}"
            km_restants_notif: "{{ states(sensor_autonomie_restante) | float(0) | round(1) }}"
            message_mensuel: >
              Bilan mensuel â€” {{ moto_nom }} :
              {{ km_mois }} km ce mois.
              KilomÃ©trage total : {{ odometer_km }} km.
              Autonomie restante : {{ km_restants_notif }} km.
        - if:
            - condition: template
              value_template: "{{ stats_mensuelles_mobile }}"
          then:
            - action: "{{ notify_service }}"
              data:
                title: "ğŸ“Š Bilan mensuel â€” {{ moto_nom }}"
                message: "{{ message_mensuel }}"
        - if:
            - condition: template
              value_template: "{{ stats_mensuelles_persistante }}"
          then:
            - action: persistent_notification.create
              data:
                title: "ğŸ“Š Bilan mensuel â€” {{ moto_nom }}"
                message: "{{ message_mensuel }}"
                notification_id: "stats_mensuelles_{{ moto_nom | slugify }}"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âœ… CONFIRMATION â€” PLEIN EFFECTUÃ‰
    # Le bouton Python btn_confirmer_le_plein gÃ¨re tout :
    #   - attend 5 min d'arrÃªt puis appelle l'API pour l'odometer prÃ©cis
    #   - met Ã  jour km_au_dernier_plein et la moyenne glissante inter-plein
    # binary_sensor.<moto>_plein_requis repasse Ã  off automatiquement dÃ¨s que
    # l'autonomie recalculÃ©e dÃ©passe Ã  nouveau le seuil.
    #
    # AprÃ¨s le 2Ã¨me plein : notification de proposition si la moyenne calculÃ©e
    # diffÃ¨re de l'autonomie totale actuelle â†’ boutons Appliquer / Garder.
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: confirm_plein
      sequence:
        - action: button.press
          target:
            entity_id: !input btn_confirmer_le_plein
        - action: "{{ notify_service }}"
          data:
            title: "â›½ Plein en cours d'enregistrement â€” {{ moto_nom }}"
            message: >
              Le plein sera enregistrÃ© aprÃ¨s confirmation d'arrÃªt (sous 5 min).
              L'autonomie sera recalculÃ©e automatiquement.
        # Attendre que le bouton Python ait calculÃ© la nouvelle moyenne
        # (dÃ©clenchÃ© au prochain verrouillage, typiquement â‰¤ 5 min)
        - delay: "00:06:00"
        - variables:
            nb_pleins_enregistres: >
              {% set p = moto_nom | lower | replace(' ', '_') %}
              {{ states('number.' ~ p ~ '_carburant_nombre_de_pleins_enregistres') | float(0) | int }}
            autonomie_moyenne: >
              {% set p = moto_nom | lower | replace(' ', '_') %}
              {{ states('number.' ~ p ~ '_carburant_autonomie_moyenne_calculee') | float(0) | round(1) }}
            autonomie_actuelle: >
              {{ states(n_autonomie_totale) | float(0) | round(1) }}
        - if:
            - condition: template
              value_template: "{{ nb_pleins_enregistres >= 2 and autonomie_moyenne > 0 and autonomie_moyenne != autonomie_actuelle }}"
          then:
            - action: "{{ notify_service }}"
              data:
                title: "ğŸ“Š Nouvelle autonomie calculÃ©e â€” {{ moto_nom }}"
                message: >
                  Moyenne sur {{ nb_pleins_enregistres }} pleins : {{ autonomie_moyenne }} km.
                  Autonomie actuelle : {{ autonomie_actuelle }} km.
                  Voulez-vous mettre Ã  jour la rÃ©fÃ©rence ?
                data:
                  actions:
                    - action: "{{ action_appliquer_autonomie }}"
                      title: "âœ… Appliquer ({{ autonomie_moyenne }} km)"
                    - action: DISMISS
                      title: "âŒ Garder ({{ autonomie_actuelle }} km)"

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âœ… APPLICATION â€” AUTONOMIE CALCULÃ‰E CONFIRMÃ‰E
    # DÃ©clenchÃ© par l'action mobile "Appliquer" de la notification de proposition.
    # Appuie sur le bouton Python qui copie autonomie_moyenne_calculee â†’ autonomie_totale.
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: confirm_appliquer_autonomie
      sequence:
        - action: button.press
          target:
            entity_id: !input btn_appliquer_autonomie
        - variables:
            autonomie_nouvelle: >
              {% set p = moto_nom | lower | replace(' ', '_') %}
              {{ states('number.' ~ p ~ '_carburant_autonomie_moyenne_calculee') | float(0) | round(1) }}
        - action: "{{ notify_service }}"
          data:
            title: "âœ… Autonomie mise Ã  jour â€” {{ moto_nom }}"
            message: >
              Autonomie de rÃ©fÃ©rence : {{ autonomie_nouvelle }} km.

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âœ… CONFIRMATION â€” CHAÃNE ENTRETENUE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: confirm_chaine
      sequence:
        - variables:
            odometer_km: "{{ states(odometer_sensor) | float(0) }}"
        - action: number.set_value
          target:
            entity_id: !input n_km_dernier_entretien_chaine
          data:
            value: "{{ odometer_km }}"
        - action: datetime.set_value
          target:
            entity_id: !input dt_date_dernier_entretien_chaine
          data:
            datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        - action: "{{ notify_service }}"
          data:
            title: "âœ… ChaÃ®ne entretenue â€” {{ moto_nom }}"
            message: >
              Entretien chaÃ®ne enregistrÃ© Ã  {{ odometer_km | round(0) }} km
              le {{ now().strftime('%d/%m/%Y') }}.

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âœ… CONFIRMATION â€” VIDANGE EFFECTUÃ‰E
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: confirm_vidange
      sequence:
        - variables:
            odometer_km: "{{ states(odometer_sensor) | float(0) }}"
        - action: number.set_value
          target:
            entity_id: !input n_km_dernier_entretien_vidange
          data:
            value: "{{ odometer_km }}"
        - action: datetime.set_value
          target:
            entity_id: !input dt_date_dernier_entretien_vidange
          data:
            datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        - action: "{{ notify_service }}"
          data:
            title: "âœ… Vidange effectuÃ©e â€” {{ moto_nom }}"
            message: >
              Vidange enregistrÃ©e Ã  {{ odometer_km | round(0) }} km
              le {{ now().strftime('%d/%m/%Y') }}.

    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # âœ… CONFIRMATION â€” RÃ‰VISION EFFECTUÃ‰E
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: confirm_revision
      sequence:
        - variables:
            odometer_km: "{{ states(odometer_sensor) | float(0) }}"
        - action: number.set_value
          target:
            entity_id: !input n_km_dernier_entretien_revision
          data:
            value: "{{ odometer_km }}"
        - action: datetime.set_value
          target:
            entity_id: !input dt_date_dernier_entretien_revision
          data:
            datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        - action: "{{ notify_service }}"
          data:
            title: "âœ… RÃ©vision effectuÃ©e â€” {{ moto_nom }}"
            message: >
              RÃ©vision enregistrÃ©e Ã  {{ odometer_km | round(0) }} km
              le {{ now().strftime('%d/%m/%Y') }}.


    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # ğŸš¨ ALARME REÃ‡UE
    # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    - conditions:
        - condition: trigger
          id: nouvelle_alarme
      sequence:
        - variables:
            alarm_type: "{{ states(last_alarm_sensor) }}"
            alarm_timestamp: "{{ state_attr(last_alarm_sensor, 'timestamp') | default('') }}"
            alarm_device: "{{ state_attr(last_alarm_sensor, 'device_name') | default(moto_nom) }}"
            is_crash: "{{ alarm_type in ['alarm_crash', 'alarm_crashParking'] }}"
            is_vibration: "{{ alarm_type == 'alarm_vibration' }}"
            is_power: "{{ alarm_type in ['alarm_powerCut', 'alarm_powerUncut'] }}"
            alarm_label: >
              {% if alarm_type == 'alarm_crash' %}ğŸ’¥ Chute dÃ©tectÃ©e
              {% elif alarm_type == 'alarm_crashParking' %}ğŸ’¥ Chute (parking)
              {% elif alarm_type == 'alarm_vibration' %}ğŸ”” Vibration / Mouvement suspect
              {% elif alarm_type == 'alarm_powerCut' %}ğŸ”Œ Coupure alimentation
              {% elif alarm_type == 'alarm_powerUncut' %}ğŸ”Œ Alimentation rÃ©tablie
              {% elif alarm_type == 'alarm_exitZone' %}ğŸ“ Sortie de zone
              {% elif alarm_type == 'alarm_batteryWarning' %}ğŸª« Batterie faible
              {% elif alarm_type == 'alarm_temperatureWarning' %}ğŸŒ¡ï¸ Alerte tempÃ©rature
              {% elif alarm_type == 'alarm_deviceOffline' %}ğŸ“µ Tracker hors ligne
              {% elif alarm_type == 'alarm_deviceOnline' %}ğŸ“¶ Tracker en ligne
              {% elif alarm_type == 'alarm_magnetOn' %}ğŸ§² Aimant dÃ©tectÃ©
              {% elif alarm_type == 'alarm_magnetOff' %}ğŸ§² Aimant retirÃ©
              {% elif alarm_type == 'alarm_sonorAlarmOn' %}ğŸ”Š Alarme sonore dÃ©clenchÃ©e
              {% else %}âš ï¸ Alarme : {{ alarm_type }}
              {% endif %}
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ notif_alarme_crash and is_crash }}"
              sequence:
                - action: "{{ notify_service }}"
                  data:
                    title: "{{ alarm_label }} â€” {{ moto_nom }}"
                    message: >
                      {{ alarm_label }} sur {{ alarm_device }}.
                      {% if alarm_timestamp %}Heure : {{ alarm_timestamp }}.{% endif %}
                    data:
                      push:
                        sound: "default"
                        interruption-level: "critical"
            - conditions:
                - condition: template
                  value_template: "{{ notif_alarme_vol and is_vibration }}"
              sequence:
                - action: "{{ notify_service }}"
                  data:
                    title: "{{ alarm_label }} â€” {{ moto_nom }}"
                    message: >
                      {{ alarm_label }} sur {{ alarm_device }}.
                      {% if alarm_timestamp %}Heure : {{ alarm_timestamp }}.{% endif %}
            - conditions:
                - condition: template
                  value_template: "{{ notif_alarme_alimentation and is_power }}"
              sequence:
                - action: "{{ notify_service }}"
                  data:
                    title: "{{ alarm_label }} â€” {{ moto_nom }}"
                    message: >
                      {{ alarm_label }} sur {{ alarm_device }}.
                      {% if alarm_timestamp %}Heure : {{ alarm_timestamp }}.{% endif %}
            - conditions:
                - condition: template
                  value_template: "{{ notif_alarme_autres and not is_crash and not is_vibration and not is_power }}"
              sequence:
                - action: "{{ notify_service }}"
                  data:
                    title: "{{ alarm_label }} â€” {{ moto_nom }}"
                    message: >
                      {{ alarm_label }} sur {{ alarm_device }}.
                      {% if alarm_timestamp %}Heure : {{ alarm_timestamp }}.{% endif %}

mode: queued
max: 10